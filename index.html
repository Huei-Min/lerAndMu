<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>樂樂＆沐沐 氣喘照護日誌</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/fonts/NotoSansCJKtc-normal.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, th, td { border: 1px solid #aaa; border-collapse: collapse; padding: 5px; }
    th { background: #eee; }
    label { margin-right: 10px; }
    h2 { color: #5b5b5b; }
  </style>
</head>
<body>
  <h2>樂樂＆沐沐 氣喘照護日誌</h2>
  <form id="logForm">
    <label>日期：<input type="date" id="date" required></label><br><br>
    <label>小朋友：
      <select id="name" required>
        <option value="樂樂">樂樂</option>
        <option value="沐沐">沐沐</option>
      </select>
    </label><br><br>
    <fieldset><legend>用藥情形</legend>
      <label>吸入劑（早）<input type="checkbox" id="inhalerMorning"></label>
      <label>吸入劑（晚）<input type="checkbox" id="inhalerEvening"></label>
      <label>欣流<input type="checkbox" id="singulair"></label>
    </fieldset><br>
    <fieldset><legend>飲食</legend>
      <label>食物名稱<input type="text" id="foodName"></label>
      <label>成分<input type="text" id="ingredients"></label>
      <label>重量（g）<input type="number" id="weight"></label>
    </fieldset><br>
    <fieldset><legend>症狀紀錄</legend>
      <label>氣喘發作<input type="checkbox" id="asthmaAttack"></label><br>
      <label>使用緊急用藥<input type="checkbox" id="emergencyUsed"></label>
      <label>使用次數<input type="number" id="emergencyTimes" value="0" min="0"></label><br><br>
      <strong>感冒症狀：</strong><br>
      <label>咳嗽<input type="checkbox" id="coldCough"></label>
      <label>流鼻水<input type="checkbox" id="coldRunnyNose"></label>
      <label>發燒<input type="checkbox" id="coldFever"></label><br><br>
      <label>鼻炎<input type="checkbox" id="rhinitis"></label>
    </fieldset><br>
    <fieldset><legend>其他觀察</legend>
      <label>夜咳<input type="checkbox" id="nightCough"></label>
      <label>白天喘鳴<input type="checkbox" id="dayWheezing"></label>
      <label>晚上喘鳴<input type="checkbox" id="nightWheezing"></label>
      <label>影響活動<input type="checkbox" id="activityLimited"></label>
      <label>皮膚搔癢<input type="checkbox" id="skinItch"></label>
      <label>起紅疹<input type="checkbox" id="rash"></label>
    </fieldset><br>
    <button type="submit">新增紀錄</button>
  </form>

  <br><hr><br>

  <label>選擇起始日期<input type="date" id="startDate"></label>
  <label>結束日期<input type="date" id="endDate"></label>
  <button onclick="exportToCSV()">匯出 CSV</button>
  <button onclick="exportToPDF()">匯出 PDF 報告</button>

  <h3>查詢特定日期紀錄</h3>
  <label>查詢日期：<input type="date" id="searchDate"></label>
  <button onclick="searchByDate()">查詢</button>
  <button onclick="resetSearch()">重設</button>

  <h3>紀錄表格</h3>
  <table id="logTable" style="width:100%;table-layout:fixed;word-wrap:break-word;">
    <thead>
      <tr>
        <th>時間</th><th>小朋友</th><th>吸入劑(早)</th><th>吸入劑(晚)</th><th>欣流</th>
        <th>食物</th><th>成分</th><th>重量</th><th>氣喘</th><th>緊急</th><th>次數</th>
        <th>咳嗽</th><th>鼻水</th><th>發燒</th><th>鼻炎</th>
        <th>夜咳</th><th>白喘</th><th>晚喘</th><th>影響活動</th><th>皮膚搔癢</th><th>起紅疹</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

<script>
  const logForm = document.getElementById("logForm");
  const tableBody = document.getElementById("tableBody");

  // 讀取 localStorage
  let records = JSON.parse(localStorage.getItem("asthmaRecords") || "[]");

  // 顯示資料到表格
  function renderTable() {
    tableBody.innerHTML = '';
    records.forEach(record => {
      const row = document.createElement("tr");
      // 按順序輸出所有欄位，確保順序與表頭一致
      const fields = [
        "time", "name", "inhalerMorning", "inhalerEvening", "singulair",
        "foodName", "ingredients", "weight", "asthmaAttack", "emergencyUsed", "emergencyTimes",
        "coldCough", "coldRunnyNose", "coldFever", "rhinitis",
        "nightCough", "dayWheezing", "nightWheezing", "activityLimited",
        "skinItch", "rash"
      ];
      fields.forEach(f => {
        const cell = document.createElement("td");
        const val = record[f];
        cell.textContent = (val === true) ? '✔️' : (val === false || val === undefined) ? '' : val;
        row.appendChild(cell);
      });
      tableBody.appendChild(row);
    });
  }

  renderTable();

  logForm.addEventListener("submit", function (e) {
    e.preventDefault();

    // 取得日期與當下時間(時分)
    const now = new Date();
    const dateStr = document.getElementById("date").value;
    const timeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
    const dateTime = dateStr + " " + timeStr;

    // 新增一筆紀錄
    const record = {
      time: dateTime,
      name: document.getElementById("name").value,
      inhalerMorning: document.getElementById("inhalerMorning").checked,
      inhalerEvening: document.getElementById("inhalerEvening").checked,
      singulair: document.getElementById("singulair").checked,
      foodName: document.getElementById("foodName").value.trim(),
      ingredients: document.getElementById("ingredients").value.trim(),
      weight: document.getElementById("weight").value,
      asthmaAttack: document.getElementById("asthmaAttack").checked,
      emergencyUsed: document.getElementById("emergencyUsed").checked,
      emergencyTimes: Number(document.getElementById("emergencyTimes").value) || 0,
      coldCough: document.getElementById("coldCough").checked,
      coldRunnyNose: document.getElementById("coldRunnyNose").checked,
      coldFever: document.getElementById("coldFever").checked,
      rhinitis: document.getElementById("rhinitis").checked,
      nightCough: document.getElementById("nightCough").checked,
      dayWheezing: document.getElementById("dayWheezing").checked,
      nightWheezing: document.getElementById("nightWheezing").checked,
      activityLimited: document.getElementById("activityLimited").checked,
      skinItch: document.getElementById("skinItch").checked,
      rash: document.getElementById("rash").checked
    };

    records.push(record);
    localStorage.setItem("asthmaRecords", JSON.stringify(records));
    renderTable();
    logForm.reset();
  });

  // 將資料依日期合併
  function groupByDate(data) {
    const grouped = {};
    data.forEach(r => {
      const date = r.time.split(' ')[0];
      if (!grouped[date]) {
        grouped[date] = {
          name: r.name,
          data: [r]
        };
      } else {
        grouped[date].data.push(r);
      }
    });
    return grouped;
  }

  // 匯出 CSV，合併同一天資料
  function exportToCSV() {
    const grouped = groupByDate(records);
    const headers = ['日期', '小朋友', '吸入劑(早)', '吸入劑(晚)', '欣流', '食物', '成分', '重量', '氣喘', '緊急', '次數', '咳嗽', '鼻水', '發燒', '鼻炎', '夜咳', '白喘', '晚喘', '影響活動', '皮膚搔癢', '起紅疹'];
    const csvRows = [headers];

    Object.entries(grouped).forEach(([date, group]) => {
      const entry = {
        date,
        name: group.name,
        inhalerMorning: '',
        inhalerEvening: '',
        singulair: '',
        foodName: [],
        ingredients: [],
        weight: [],
        asthmaAttack: '',
        emergencyUsed: '',
        emergencyTimes: 0,
        coldCough: '',
        coldRunnyNose: '',
        coldFever: '',
        rhinitis: '',
        nightCough: '',
        dayWheezing: '',
        nightWheezing: '',
        activityLimited: '',
        skinItch: '',
        rash: ''
      };

      group.data.forEach(r => {
        if (r.inhalerMorning) entry.inhalerMorning = '✔️';
        if (r.inhalerEvening) entry.inhalerEvening = '✔️';
        if (r.singulair) entry.singulair = '✔️';
        if (r.asthmaAttack) entry.asthmaAttack = '✔️';
        if (r.emergencyUsed) entry.emergencyUsed = '✔️';
        if (r.coldCough) entry.coldCough = '✔️';
        if (r.coldRunnyNose) entry.coldRunnyNose = '✔️';
        if (r.coldFever) entry.coldFever = '✔️';
        if (r.rhinitis) entry.rhinitis = '✔️';
        if (r.nightCough) entry.nightCough = '✔️';
        if (r.dayWheezing) entry.dayWheezing = '✔️';
        if (r.nightWheezing) entry.nightWheezing = '✔️';
        if (r.activityLimited) entry.activityLimited = '✔️';
        if (r.skinItch) entry.skinItch = '✔️';
        if (r.rash) entry.rash = '✔️';

        if (r.foodName) entry.foodName.push(r.foodName);
        if (r.ingredients) entry.ingredients.push(r.ingredients);
        if (r.weight) entry.weight.push(r.weight);
        entry.emergencyTimes += Number(r.emergencyTimes || 0);
      });

      csvRows.push([
        entry.date,
        entry.name,
        entry.inhalerMorning,
        entry.inhalerEvening,
        entry.singulair,
        entry.foodName.join(' / '),
        entry.ingredients.join(' / '),
        entry.weight.join(' / '),
        entry.asthmaAttack,
        entry.emergencyUsed,
        entry.emergencyTimes,
        entry.coldCough,
        entry.coldRunnyNose,
        entry.coldFever,
        entry.rhinitis,
        entry.nightCough,
        entry.dayWheezing,
        entry.nightWheezing,
        entry.activityLimited,
        entry.skinItch,
        entry.rash
      ]);
    });

    const blob = new Blob([csvRows.map(r => r.join(',')).join('\n')], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = '氣喘日誌_整合.csv';
    a.click();
  }

  // 匯出 PDF，合併同一天資料
  function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFont('NotoSansCJKtc', 'normal');
    doc.setFontSize(14);

    const grouped = groupByDate(records);
    let y = 20;

    Object.entries(grouped).forEach(([date, group]) => {
      doc.text(`日期：${date}  小朋友：${group.name}`, 10, y);
      y += 10;

      // 合併描述，示範用食物和症狀簡略列出
      const foods = group.data.map(r => r.foodName).filter(Boolean).join(' / ');
      if(foods) {
        doc.text(`食物：${foods}`, 10, y);
        y += 8;
      }

      // 症狀標示
      const symptomsLabels = ['吸入劑(早)', '吸入劑(晚)', '欣流', '氣喘', '使用緊急用藥', '咳嗽', '流鼻水', '發燒', '鼻炎', '夜咳', '白喘', '晚喘', '影響活動', '皮膚搔癢', '起紅疹'];
      const symptomFields = ['inhalerMorning','inhalerEvening','singulair','asthmaAttack','emergencyUsed','coldCough','coldRunnyNose','coldFever','rhinitis','nightCough','dayWheezing','nightWheezing','activityLimited','skinItch','rash'];
      const symptomStatus = {};

      symptomFields.forEach(f => symptomStatus[f] = false);

      group.data.forEach(r => {
        symptomFields.forEach(f => {
          if (r[f]) symptomStatus[f] = true;
        });
      });

      let symptomText = symptomFields.map((f,i) => symptomStatus[f] ? symptomsLabels[i] : null).filter(Boolean).join('、');
      if(symptomText){
        doc.text(`症狀：${symptomText}`, 10, y);
        y += 10;
      }

      // 用藥次數合計
      let emergencyTimesSum = group.data.reduce((sum,r) => sum + Number(r.emergencyTimes || 0),0);
      doc.text(`緊急用藥次數合計：${emergencyTimesSum}`, 10, y);
      y += 12;

      if(y > 270){
        doc.addPage();
        y = 20;
      }
    });

    doc.save("氣喘日誌_整合.pdf");
  }

  // 查詢特定日期
  function searchByDate() {
    const searchDate = document.getElementById('searchDate').value;
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
      const date = row.querySelector('td').textContent.split(' ')[0];
      row.style.display = (date === searchDate) ? '' : 'none';
    });
  }

  // 重設查詢，顯示全部
  function resetSearch() {
    document.getElementById('searchDate').value = '';
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => row.style.display = '');
  }
</script>
</body>
</html>
