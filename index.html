<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æ¨‚æ¨‚ï¼†æ²æ² æ°£å–˜ç…§è­·æ—¥èªŒ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, th, td { border: 1px solid #aaa; border-collapse: collapse; padding: 5px; }
    th { background: #eee; }
    label { margin-right: 10px; }
    h2 { color: #5b5b5b; }
  </style>
</head>
<body>
  <h2>æ°£å–˜ç…§è­·æ—¥èªŒï¼ˆæ¨‚æ¨‚ï¼†æ²æ²ï¼‰</h2>
  <form id="logForm">
    <label>æ—¥æœŸï¼š<input type="date" id="date" required></label><br><br>
    <label>å°æœ‹å‹ï¼š
      <select id="name" required>
        <option value="æ¨‚æ¨‚">æ¨‚æ¨‚</option>
        <option value="æ²æ²">æ²æ²</option>
      </select>
    </label><br><br>
    <fieldset><legend>ç”¨è—¥æƒ…å½¢</legend>
      <label>å¸å…¥åŠ‘ï¼ˆæ—©ï¼‰<input type="checkbox" id="inhalerMorning"></label>
      <label>å¸å…¥åŠ‘ï¼ˆæ™šï¼‰<input type="checkbox" id="inhalerEvening"></label>
      <label>æ¬£æµ<input type="checkbox" id="singulair"></label>
    </fieldset><br>
    <fieldset><legend>é£²é£Ÿ</legend>
      <label>é£Ÿç‰©åç¨±<input type="text" id="foodName"></label>
      <label>æˆåˆ†<input type="text" id="ingredients"></label>
      <label>é‡é‡ï¼ˆgï¼‰<input type="number" id="weight"></label>
    </fieldset><br>
    <fieldset><legend>ç—‡ç‹€ç´€éŒ„</legend>
      <label>æ°£å–˜ç™¼ä½œ<input type="checkbox" id="asthmaAttack"></label><br>
      <label>ä½¿ç”¨ç·Šæ€¥ç”¨è—¥<input type="checkbox" id="emergencyUsed"></label>
      <label>ä½¿ç”¨æ¬¡æ•¸<input type="number" id="emergencyTimes" value="0"></label><br><br>
      <strong>æ„Ÿå†’ç—‡ç‹€ï¼š</strong><br>
      <label>å’³å—½<input type="checkbox" id="coldCough"></label>
      <label>æµé¼»æ°´<input type="checkbox" id="coldRunnyNose"></label>
      <label>ç™¼ç‡’<input type="checkbox" id="coldFever"></label><br><br>
      <label>é¼»ç‚<input type="checkbox" id="rhinitis"></label>
    </fieldset><br>
    <button type="submit">æ–°å¢ç´€éŒ„</button>
  </form>

  <br><hr><br>

  <label>é¸æ“‡èµ·å§‹æ—¥æœŸ<input type="date" id="startDate"></label>
  <label>çµæŸæ—¥æœŸ<input type="date" id="endDate"></label>
  <button onclick="exportToCSV()">åŒ¯å‡º CSV</button>
  <button onclick="exportToPDF()">åŒ¯å‡º PDF å ±å‘Š</button>

  <h3>ç´€éŒ„è¡¨æ ¼</h3>
  <table id="logTable">
    <thead>
      <tr><th>æ—¥æœŸ</th><th>å°æœ‹å‹</th><th>å¸å…¥åŠ‘(æ—©)</th><th>å¸å…¥åŠ‘(æ™š)</th><th>æ¬£æµ</th><th>é£Ÿç‰©</th><th>æˆåˆ†</th><th>é‡é‡</th><th>æ°£å–˜</th><th>ç·Šæ€¥</th><th>æ¬¡æ•¸</th><th>å’³å—½</th><th>é¼»æ°´</th><th>ç™¼ç‡’</th><th>é¼»ç‚</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const form = document.getElementById('logForm');
    const tableBody = document.querySelector('#logTable tbody');
    const records = [];

    form.addEventListener('submit', e => {
      e.preventDefault();
      const record = {
        date: document.getElementById('date').value,
        name: document.getElementById('name').value,
        inhalerMorning: document.getElementById('inhalerMorning').checked,
        inhalerEvening: document.getElementById('inhalerEvening').checked,
        singulair: document.getElementById('singulair').checked,
        foodName: document.getElementById('foodName').value,
        ingredients: document.getElementById('ingredients').value,
        weight: document.getElementById('weight').value,
        asthmaAttack: document.getElementById('asthmaAttack').checked,
        emergencyUsed: document.getElementById('emergencyUsed').checked,
        emergencyTimes: document.getElementById('emergencyTimes').value,
        coldCough: document.getElementById('coldCough').checked,
        coldRunnyNose: document.getElementById('coldRunnyNose').checked,
        coldFever: document.getElementById('coldFever').checked,
        rhinitis: document.getElementById('rhinitis').checked
      };
      records.push(record);
      const row = document.createElement('tr');
      Object.values(record).forEach(val => {
        const td = document.createElement('td');
        td.textContent = typeof val === "boolean" ? (val ? "âœ”ï¸" : "") : val;
        row.appendChild(td);
      });
      tableBody.appendChild(row);
      form.reset();
    });

    function exportToCSV() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) return alert("è«‹é¸æ“‡æ—¥æœŸ");

      const filtered = records.filter(r => r.date >= startDate && r.date <= endDate);
      if (filtered.length === 0) return alert("å€é–“å…§ç„¡è³‡æ–™");

      const headers = "æ—¥æœŸ,å¸å…¥åŠ‘(æ—©),å¸å…¥åŠ‘(æ™š),æ¬£æµ,é£Ÿç‰©,æˆåˆ†,é‡é‡,ç™¼ä½œ,ç·Šæ€¥,æ¬¡æ•¸,å’³å—½,æµé¼»æ°´,ç™¼ç‡’,é¼»ç‚\n";
      const icon = (val) => val ? "âœ”ï¸" : "";

      const group = {
        æ¨‚æ¨‚: filtered.filter(r => r.name === 'æ¨‚æ¨‚'),
        æ²æ²: filtered.filter(r => r.name === 'æ²æ²')
      };

      let csv = "";
      for (const name in group) {
        const entries = group[name];
        if (entries.length > 0) {
          csv += `=== ${name} ===\n` + headers;
          entries.forEach(r => {
            csv += `${r.date},${icon(r.inhalerMorning)},${icon(r.inhalerEvening)},${icon(r.singulair)},${r.foodName},${r.ingredients},${r.weight},${icon(r.asthmaAttack)},${icon(r.emergencyUsed)},${r.emergencyTimes},${icon(r.coldCough)},${icon(r.coldRunnyNose)},${icon(r.coldFever)},${icon(r.rhinitis)}\n`;
          });
          csv += "\n";
        }
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `æ°£å–˜ç´€éŒ„_${startDate}_to_${endDate}.csv`;
      link.click();
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) return alert("è«‹é¸æ“‡æ—¥æœŸ");

      const filtered = records.filter(r => r.date >= startDate && r.date <= endDate);
      if (filtered.length === 0) return alert("å€é–“å…§ç„¡è³‡æ–™");

      const icon = val => val ? "âœ”ï¸" : "âœ˜";
      const group = {
        æ¨‚æ¨‚: filtered.filter(r => r.name === 'æ¨‚æ¨‚'),
        æ²æ²: filtered.filter(r => r.name === 'æ²æ²')
      };

      let y = 20;
      doc.setFontSize(16);
      doc.text(`æ°£å–˜ç´€éŒ„å ±å‘Šï¼š${startDate} ~ ${endDate}`, 14, y);
      y += 10;

      for (const name in group) {
        const entries = group[name];
        if (entries.length > 0) {
          doc.setFontSize(14);
          doc.text(`ğŸ‘§ ${name}`, 14, y);
          y += 8;
          doc.setFontSize(10);
          doc.text("æ—¥æœŸï½œå¸(æ—©) å¸(æ™š) æ¬£æµï½œé£Ÿç‰©ï½œæˆåˆ†ï½œé‡(g)ï½œç™¼ä½œï½œç·Šæ€¥ï½œæ¬¡æ•¸ï½œå’³ï½œé¼»æ°´ï½œç‡’ï½œé¼»ç‚", 14, y);
          y += 6;
          entries.forEach(r => {
            const row = `${r.date}ï½œ ${icon(r.inhalerMorning)} ${icon(r.inhalerEvening)} ${icon(r.singulair)} ï½œ${r.foodName}ï½œ${r.ingredients}ï½œ${r.weight}ï½œ${icon(r.asthmaAttack)}ï½œ${icon(r.emergencyUsed)}ï½œ${r.emergencyTimes}ï½œ${icon(r.coldCough)}ï½œ${icon(r.coldRunnyNose)}ï½œ${icon(r.coldFever)}ï½œ${icon(r.rhinitis)}`;
            doc.text(row, 14, y);
            y += 6;
            if (y > 270) { doc.addPage(); y = 20; }
          });
          y += 10;
        }
      }
      doc.save(`æ°£å–˜ç´€éŒ„_${startDate}_to_${endDate}.pdf`);
    }
  </script>
</body>
</html>