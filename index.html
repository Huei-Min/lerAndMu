<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>樂樂＆沐沐 氣喘照護日誌</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, th, td { border: 1px solid #aaa; border-collapse: collapse; padding: 5px; }
    th { background: #eee; }
    label { margin-right: 10px; }
    h2 { color: #5b5b5b; }
  </style>
</head>
<body>
  <h2>氣喘照護日誌（樂樂＆沐沐）</h2>
  <form id="logForm">
    <label>日期：<input type="date" id="date" required></label><br><br>
    <label>小朋友：
      <select id="name" required>
        <option value="樂樂">樂樂</option>
        <option value="沐沐">沐沐</option>
      </select>
    </label><br><br>
    <fieldset><legend>用藥情形</legend>
      <label>吸入劑（早）<input type="checkbox" id="inhalerMorning"></label>
      <label>吸入劑（晚）<input type="checkbox" id="inhalerEvening"></label>
      <label>欣流<input type="checkbox" id="singulair"></label>
    </fieldset><br>
    <fieldset><legend>飲食</legend>
      <label>食物名稱<input type="text" id="foodName"></label>
      <label>成分<input type="text" id="ingredients"></label>
      <label>重量（g）<input type="number" id="weight"></label>
    </fieldset><br>
    <fieldset><legend>症狀紀錄</legend>
      <label>氣喘發作<input type="checkbox" id="asthmaAttack"></label><br>
      <label>使用緊急用藥<input type="checkbox" id="emergencyUsed"></label>
      <label>使用次數<input type="number" id="emergencyTimes" value="0"></label><br><br>
      <strong>感冒症狀：</strong><br>
      <label>咳嗽<input type="checkbox" id="coldCough"></label>
      <label>流鼻水<input type="checkbox" id="coldRunnyNose"></label>
      <label>發燒<input type="checkbox" id="coldFever"></label><br><br>
      <label>鼻炎<input type="checkbox" id="rhinitis"></label>
    </fieldset><br>
    <button type="submit">新增紀錄</button>
  </form>

  <br><hr><br>

  <label>選擇起始日期<input type="date" id="startDate"></label>
  <label>結束日期<input type="date" id="endDate"></label>
  <button onclick="exportToCSV()">匯出 CSV</button>
  <button onclick="exportToPDF()">匯出 PDF 報告</button>

  <h3>紀錄表格</h3>
  <table id="logTable">
    <thead>
      <tr><th>日期</th><th>小朋友</th><th>吸入劑(早)</th><th>吸入劑(晚)</th><th>欣流</th><th>食物</th><th>成分</th><th>重量</th><th>氣喘</th><th>緊急</th><th>次數</th><th>咳嗽</th><th>鼻水</th><th>發燒</th><th>鼻炎</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const form = document.getElementById('logForm');
    const tableBody = document.querySelector('#logTable tbody');
    const records = [];

    form.addEventListener('submit', e => {
      e.preventDefault();
      const record = {
        date: document.getElementById('date').value,
        name: document.getElementById('name').value,
        inhalerMorning: document.getElementById('inhalerMorning').checked,
        inhalerEvening: document.getElementById('inhalerEvening').checked,
        singulair: document.getElementById('singulair').checked,
        foodName: document.getElementById('foodName').value,
        ingredients: document.getElementById('ingredients').value,
        weight: document.getElementById('weight').value,
        asthmaAttack: document.getElementById('asthmaAttack').checked,
        emergencyUsed: document.getElementById('emergencyUsed').checked,
        emergencyTimes: document.getElementById('emergencyTimes').value,
        coldCough: document.getElementById('coldCough').checked,
        coldRunnyNose: document.getElementById('coldRunnyNose').checked,
        coldFever: document.getElementById('coldFever').checked,
        rhinitis: document.getElementById('rhinitis').checked
      };
      records.push(record);
      const row = document.createElement('tr');
      Object.values(record).forEach(val => {
        const td = document.createElement('td');
        td.textContent = typeof val === "boolean" ? (val ? "✔️" : "") : val;
        row.appendChild(td);
      });
      tableBody.appendChild(row);
      form.reset();
    });

    function exportToCSV() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) return alert("請選擇日期");

      const filtered = records.filter(r => r.date >= startDate && r.date <= endDate);
      if (filtered.length === 0) return alert("區間內無資料");

      const headers = "日期,吸入劑(早),吸入劑(晚),欣流,食物,成分,重量,發作,緊急,次數,咳嗽,流鼻水,發燒,鼻炎\n";
      const icon = (val) => val ? "✔️" : "";

      const group = {
        樂樂: filtered.filter(r => r.name === '樂樂'),
        沐沐: filtered.filter(r => r.name === '沐沐')
      };

      let csv = "";
      for (const name in group) {
        const entries = group[name];
        if (entries.length > 0) {
          csv += `=== ${name} ===\n` + headers;
          entries.forEach(r => {
            csv += `${r.date},${icon(r.inhalerMorning)},${icon(r.inhalerEvening)},${icon(r.singulair)},${r.foodName},${r.ingredients},${r.weight},${icon(r.asthmaAttack)},${icon(r.emergencyUsed)},${r.emergencyTimes},${icon(r.coldCough)},${icon(r.coldRunnyNose)},${icon(r.coldFever)},${icon(r.rhinitis)}\n`;
          });
          csv += "\n";
        }
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `氣喘紀錄_${startDate}_to_${endDate}.csv`;
      link.click();
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) return alert("請選擇日期");

      const filtered = records.filter(r => r.date >= startDate && r.date <= endDate);
      if (filtered.length === 0) return alert("區間內無資料");

      const icon = val => val ? "✔️" : "✘";
      const group = {
        樂樂: filtered.filter(r => r.name === '樂樂'),
        沐沐: filtered.filter(r => r.name === '沐沐')
      };

      let y = 20;
      doc.setFontSize(16);
      doc.text(`氣喘紀錄報告：${startDate} ~ ${endDate}`, 14, y);
      y += 10;

      for (const name in group) {
        const entries = group[name];
        if (entries.length > 0) {
          doc.setFontSize(14);
          doc.text(`👧 ${name}`, 14, y);
          y += 8;
          doc.setFontSize(10);
          doc.text("日期｜吸(早) 吸(晚) 欣流｜食物｜成分｜重(g)｜發作｜緊急｜次數｜咳｜鼻水｜燒｜鼻炎", 14, y);
          y += 6;
          entries.forEach(r => {
            const row = `${r.date}｜ ${icon(r.inhalerMorning)} ${icon(r.inhalerEvening)} ${icon(r.singulair)} ｜${r.foodName}｜${r.ingredients}｜${r.weight}｜${icon(r.asthmaAttack)}｜${icon(r.emergencyUsed)}｜${r.emergencyTimes}｜${icon(r.coldCough)}｜${icon(r.coldRunnyNose)}｜${icon(r.coldFever)}｜${icon(r.rhinitis)}`;
            doc.text(row, 14, y);
            y += 6;
            if (y > 270) { doc.addPage(); y = 20; }
          });
          y += 10;
        }
      }
      doc.save(`氣喘紀錄_${startDate}_to_${endDate}.pdf`);
    }
  </script>
</body>
</html>